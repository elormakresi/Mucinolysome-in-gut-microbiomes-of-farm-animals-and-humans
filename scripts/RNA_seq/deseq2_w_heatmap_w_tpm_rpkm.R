library(DESeq2)
library(readr)
library(dplyr)
library(genefilter)
library(ggplot2)
library(ggrepel)
library(GenomicFeatures)
library(rtracklayer)
library(tibble)

## for Deseq2 analysis

# Path to the gene_counts.txt file generated by featureCounts
counts_file <- "./reference_based_started_on_swan/gene_counts.txt"
# Path to save the DESeq2 results
output_dir <- "./reference_based_started_on_swan/deseq2_ref_based_results_tpm_rpkm"
# Path to a text file containing gene IDs to label on the Volcano Plot (one gene ID per line)
genes_to_label_file <- "./reference_based_started_on_swan/genes_to_label_only_upreg.txt"
#path to GTF for gene lengths
gtf_file <- "./reference_based_started_on_swan/kol109.gtf"

# Create output directory if it doesn't exist
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# 1. Load gene count matrix from featureCounts output
counts_data <- read_tsv(counts_file, comment = "#")

raw_colnames <- colnames(counts_data)[7:ncol(counts_data)]
sample_names <- basename(raw_colnames) %>%
                  gsub("_sorted\\.bam$", "", .)

count_matrix <- as.matrix(counts_data[, 7:ncol(counts_data)])
colnames(count_matrix) <- sample_names
rownames(count_matrix) <- counts_data$Geneid

cat("Dimensions of count_matrix:", dim(count_matrix), "\n")
print(head(count_matrix))

# 2. Create Sample Metadata (colData)
sample_info <- data.frame(
  Sample = colnames(count_matrix),
  Condition = c(rep("GroupG", 3), rep("GroupM", 3)),
  row.names = colnames(count_matrix)
)

cat("\nSample metadata (colData):\n")
print(sample_info)

sample_info <- sample_info[colnames(count_matrix), , drop = FALSE]
stopifnot(all(rownames(sample_info) == colnames(count_matrix)))


# 3. Create DESeqDataSet object
dds <- DESeqDataSetFromMatrix(countData = count_matrix,
                              colData = sample_info,
                              design = ~ Condition)

# Set the reference level for 'Condition'
# This ensures that log2FoldChange is calculated as (GroupM / GroupG)
dds$Condition <- relevel(dds$Condition, ref = "GroupG")


# 4. Pre-filtering
cat("\nNumber of genes before filtering:", nrow(dds), "\n")
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]
cat("Number of genes after filtering:", nrow(dds), "\n")


# 5. Run DESeq2 analysis
cat("\nRunning DESeq2 analysis...\n")
dds <- DESeq(dds)
cat("DESeq2 analysis complete.\n")


# 6. Extract Results
results_deseq <- results(dds, contrast = c("Condition", "GroupM", "GroupG"))

# Order results by adjusted p-value (padj)
results_deseq_ordered <- results_deseq[order(results_deseq$padj),]

cat("\nColumn names in DESeq2 results:\n")
print(colnames(results_deseq))

cat("\nTop differentially expressed genes (ordered by padj):\n")
print(head(results_deseq_ordered))

# --- IMPORTANT: Filter and Count DEGs, Upregulated, and Downregulated Genes ---
alpha <- 0.05 # Significance threshold for adjusted p-value
lfc_threshold <- 1 # Log2 fold change threshold (e.g., 1 means 2-fold change)

# Convert results to a data frame for easier filtering and manipulation
results_df_filtered <- as.data.frame(results_deseq_ordered) %>%
  # Filter for genes meeting padj threshold
  filter(padj < alpha)

# Calculate total DEGs meeting both thresholds
total_degs <- results_df_filtered %>%
  filter(abs(log2FoldChange) > lfc_threshold)

# Count upregulated genes
upregulated_genes <- total_degs %>%
  filter(log2FoldChange > lfc_threshold)

# Count downregulated genes
downregulated_genes <- total_degs %>%
  filter(log2FoldChange < -lfc_threshold)

# Print the counts
cat(paste0("\n--- Differential Expression Summary (padj < ", alpha, ", |log2FoldChange| > ", lfc_threshold, ") ---\n"))
cat(paste0("Total number of genes tested: ", nrow(results_deseq_ordered), "\n"))
cat(paste0("Total DEGs meeting thresholds: ", nrow(total_degs), "\n"))
cat(paste0("Number of Upregulated DEGs (in GroupM vs GroupG): ", nrow(upregulated_genes), "\n"))
cat(paste0("Number of Downregulated DEGs (in GroupM vs GroupG): ", nrow(downregulated_genes), "\n"))
cat("-----------------------------------------------------------------------------------\n")

# Save the full table of results
results_file <- file.path(output_dir, "deseq2_differential_expression_results.csv")
write.csv(as.data.frame(results_deseq_ordered), file = results_file)
cat("\nFull differential expression results saved to:", results_file, "\n")

# Save only significant genes (total) to a separate file (optional)
if (nrow(total_degs) > 0) {
  significant_genes_file <- file.path(output_dir, "deseq2_significant_genes_total.csv")
  write.csv(total_degs, file = significant_genes_file)
  cat("Total significant genes (filtered by padj and LFC) saved to:", significant_genes_file, "\n")
}

# --- Save Upregulated and Downregulated Genes to separate files ---
if (nrow(upregulated_genes) > 0) {
  upregulated_genes_file <- file.path(output_dir, "deseq2_upregulated_genes.csv")
  write.csv(upregulated_genes, file = upregulated_genes_file)
  cat("Upregulated genes saved to:", upregulated_genes_file, "\n")
} else {
  cat("No upregulated genes found to save.\n")
}

if (nrow(downregulated_genes) > 0) {
  downregulated_genes_file <- file.path(output_dir, "deseq2_downregulated_genes.csv")
  write.csv(downregulated_genes, file = downregulated_genes_file)
  cat("Downregulated genes saved to:", downregulated_genes_file, "\n")
} else {
  cat("No downregulated genes found to save.\n")
}
# --- Visualization ---

# Data Transformation for Visualization (e.g., PCA, Heatmaps)
cat("\nPerforming VST transformation for visualization...\n")
vsd <- vst(dds, blind = FALSE)
vst_counts <- assay(vsd)
vst_counts_file <- file.path(output_dir, "vst_normalized_counts.csv")
write.csv(vst_counts, file = vst_counts_file)
cat("VST normalized counts saved to:", vst_counts_file, "\n")


gtf_gr <- import(gtf_file)

# Use gene_id if present, else transcript_id
mcols(gtf_gr)$gene_id[is.na(mcols(gtf_gr)$gene_id)] <- mcols(gtf_gr)$transcript_id[is.na(mcols(gtf_gr)$gene_id)]

# Build TxDb
txdb <- makeTxDbFromGRanges(gtf_gr)

# --- Calculate Gene Lengths from GTF ---
exons_by_gene <- exonsBy(txdb, by="gene")

# Sum exon widths per gene
gene_lengths <- sapply(exons_by_gene, function(x) sum(width(reduce(x))))

# Keep only genes present in count_matrix and reorder
gene_lengths <- gene_lengths[names(gene_lengths) %in% rownames(count_matrix)]
gene_lengths <- gene_lengths[rownames(count_matrix)]

# --- RPKM Calculation ---
counts <- count_matrix[rownames(count_matrix) %in% names(gene_lengths), ]
gene_lengths_kb <- gene_lengths / 1000
lib_sizes_million <- colSums(counts) / 1e6

rpkm <- t(t(counts) / lib_sizes_million) / gene_lengths_kb

# Merge DESeq2 results
rpkm_df <- as.data.frame(rpkm)
if (exists("res")) {
  rpkm_df <- rpkm_df %>% 
    mutate(gene = rownames(rpkm_df)) %>% 
    left_join(as.data.frame(res) %>% mutate(gene = rownames(res)), by = "gene")
}

write.csv(rpkm_df, file.path(output_dir, "RPKM_matrix_with_DESeq2.csv"))
cat("\nRPKM matrix saved.\n")

# --- TPM Calculation ---
counts_per_kb <- counts / gene_lengths_kb
per_sample_scaling <- colSums(counts_per_kb) / 1e6
tpm <- t(t(counts_per_kb) / per_sample_scaling)

# Merge DESeq2 results
tpm_df <- as.data.frame(tpm)
if (exists("res")) {
  tpm_df <- tpm_df %>% 
    mutate(gene = rownames(tpm_df)) %>% 
    left_join(as.data.frame(res) %>% mutate(gene = rownames(res)), by = "gene")
}

write.csv(tpm_df, file.path(output_dir, "TPM_matrix_with_DESeq2.csv"))
cat("TPM matrix saved.\n")


# --- Average per group ---
# --- Determine expression columns ---
rpkm_expr_cols <- if (exists("res")) {
  1:(ncol(rpkm_df) - ncol(res))
} else {
  1:ncol(rpkm_df)
}

tpm_expr_cols <- if (exists("res")) {
  1:(ncol(tpm_df) - ncol(res))
} else {
  1:ncol(tpm_df)
}

# --- Average per group without grouping ---
average_by_group <- function(df) {
  G_cols <- grep("^G", colnames(df))  # find all G columns
  M_cols <- grep("^M", colnames(df))  # find all M columns

  df_avg <- data.frame(
    G_avg = rowMeans(df[, G_cols, drop=FALSE]),
    M_avg = rowMeans(df[, M_cols, drop=FALSE])
  )
  
  # preserve rownames as gene IDs
  rownames(df_avg) <- rownames(df)
  
  return(df_avg)
}

# --- Apply ---
rpkm_avg <- average_by_group(rpkm_df[, rpkm_expr_cols])
tpm_avg  <- average_by_group(tpm_df[, tpm_expr_cols])

# --- Save ---
write.csv(rpkm_avg, file.path(output_dir, "RPKM_matrix_average.csv"))
write.csv(tpm_avg, file.path(output_dir, "TPM_matrix_average.csv"))


# Volcano Plot (Visualizing LFC vs p-value)
cat("\nGenerating Volcano Plot...\n")

results_df_for_plot <- as.data.frame(results_deseq_ordered)

results_df_for_plot <- results_df_for_plot %>%
  mutate(
    Significance = case_when(
      padj < alpha & log2FoldChange > lfc_threshold ~ "Upregulated",
      padj < alpha & log2FoldChange < -lfc_threshold ~ "Downregulated",
      TRUE ~ "Not significant"
    )
  )

plot_colors <- c("Upregulated" = "red", "Downregulated" = "blue", "Not significant" = "grey")

# Read genes to label from file
genes_to_label <- character(0) # Initialize as empty character vector
if (file.exists(genes_to_label_file)) {
  genes_to_label <- readLines(genes_to_label_file) %>% unique()
  cat(paste0("\nFound ", length(genes_to_label), " genes to label on Volcano Plot.\n"))
} else {
  cat(paste0("\nWarning: Gene label file not found at '", genes_to_label_file, "'. No specific genes will be labeled.\n"))
}

#  Add a column for labels; only label if gene is in genes_to_label list
results_df_for_plot$GeneLabel <- ifelse(rownames(results_df_for_plot) %in% genes_to_label,
                                        rownames(results_df_for_plot),
                                        NA)

volcano_plot <- ggplot(results_df_for_plot, aes(x = log2FoldChange, y = -log10(padj), color = Significance)) +
  geom_point(alpha = 0.8, size = 1.5) +
  scale_color_manual(values = plot_colors) +
  labs(
    title = paste0("Volcano Plot (GroupM vs GroupG)"),
    x = "Log2 Fold Change",
    y = "-Log10 Adjusted P-value"
  ) +
  geom_hline(yintercept = -log10(alpha), linetype = "dashed", color = "black") +
  geom_vline(xintercept = c(-lfc_threshold, lfc_threshold), linetype = "dashed", color = "black") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  #  Add gene labels for specified genes
  geom_text_repel(aes(label = GeneLabel), # Use the new GeneLabel column
                  box.padding = 0.5, point.padding = 0.5,
                  min.segment.length = 0,
                  max.overlaps = Inf, # Adjust this if too many labels overlap
                  size = 3, color = "black", # Text color for labels
                  na.rm = TRUE) # Don't plot labels for NA values

volcano_plot_file <- file.path(output_dir, "volcano_plot.pdf")
ggsave(volcano_plot_file, plot = volcano_plot, width = 8, height = 6, dpi = 300)
cat("Volcano plot saved to:", volcano_plot_file, "\n")

}

cat("\nAnalysis complete. Check the output directory for results and plots.\n")

# To exit R:
# q()
